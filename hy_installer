#!/bin/bash

# ASCII-арт
cat << "EOF"
_|    _|            _|_|_|                        _|                        _|      
_|    _|  _|    _|  _|    _|  _|  _|_|    _|_|          _|_|      _|_|_|  _|_|_|_|  
_|_|_|_|  _|    _|  _|_|_|    _|_|      _|    _|  _|  _|_|_|_|  _|          _|      
_|    _|  _|    _|  _|        _|        _|    _|  _|  _|        _|          _|      
_|    _|    _|_|_|  _|        _|          _|_|    _|    _|_|_|    _|_|_|      _|_|
EOF

# Проверка наличия установленной утилиты dialog и её установка, если она отсутствует
if ! command -v dialog &> /dev/null; then
    echo "Утилита 'dialog' не найдена. Устанавливаем её..."
    sudo apt-get update
    sudo apt-get install -y dialog
fi

# Функция для установки Pterodactyl
install_pterodactyl() {
    echo "Установка Pterodactyl..."
    # Установка зависимостей
    sudo apt-get update
    sudo apt-get install -y curl git unzip

    # Настройка Nginx
    nginx_config=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка Nginx для Pterodactyl" \
        --inputbox "Введите доменное имя для Pterodactyl:" 10 60 2>&1 >/dev/tty)
    clear

    # Настройка базы данных
    db_name=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Pterodactyl" \
        --inputbox "Введите имя базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    db_user=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Pterodactyl" \
        --inputbox "Введите имя пользователя базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    db_password=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Pterodactyl" \
        --passwordbox "Введите пароль для базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    # Скачивание и установка Pterodactyl
    git clone https://github.com/pterodactyl/panel.git
    cd panel
    composer install --no-dev --optimize-autoloader
    cp .env.example .env
    php artisan key:generate --force

    # Настройка .env файла
    sed -i "s/DB_DATABASE=panel/DB_DATABASE=$db_name/" .env
    sed -i "s/DB_USERNAME=pterodactyl/DB_USERNAME=$db_user/" .env
    sed -i "s/DB_PASSWORD=/DB_PASSWORD=$db_password/" .env

    # Настройка Nginx
    sudo bash -c "cat > /etc/nginx/sites-available/pterodactyl.conf <<EOF
server {
    listen 80;
    server_name $nginx_config;

    root /var/www/pterodactyl/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }
}
EOF"
    sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
    sudo systemctl restart nginx

    # Настройка базы данных
    sudo mysql -e "CREATE DATABASE $db_name;"
    sudo mysql -e "CREATE USER '$db_user'@'localhost' IDENTIFIED BY '$db_password';"
    sudo mysql -e "GRANT ALL PRIVILEGES ON $db_name.* TO '$db_user'@'localhost';"
    sudo mysql -e "FLUSH PRIVILEGES;"

    echo "Pterodactyl установлен."
}

# Функция для установки Plexactyl
install_plexactyl() {
    echo "Установка Plexactyl..."
    # Установка зависимостей
    sudo apt-get update
    sudo apt-get install -y curl git unzip

    # Настройка Nginx
    nginx_config=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка Nginx для Plexactyl" \
        --inputbox "Введите доменное имя для Plexactyl:" 10 60 2>&1 >/dev/tty)
    clear

    # Настройка базы данных
    db_name=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Plexactyl" \
        --inputbox "Введите имя базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    db_user=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Plexactyl" \
        --inputbox "Введите имя пользователя базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    db_password=$(dialog --clear --backtitle "HyProject Installer" \
        --title "Настройка базы данных для Plexactyl" \
        --passwordbox "Введите пароль для базы данных:" 10 60 2>&1 >/dev/tty)
    clear

    # Скачивание и установка Plexactyl
    git clone https://github.com/NinoviumLabs/plexactyl.git
    cd plexactyl
    composer install --no-dev --optimize-autoloader
    cp .env.example .env
    php artisan key:generate --force

    # Настройка .env файла
    sed -i "s/DB_DATABASE=plexactyl/DB_DATABASE=$db_name/" .env
    sed -i "s/DB_USERNAME=plexactyl/DB_USERNAME=$db_user/" .env
    sed -i "s/DB_PASSWORD=/DB_PASSWORD=$db_password/" .env

    # Настройка Nginx
    sudo bash -c "cat > /etc/nginx/sites-available/plexactyl.conf <<EOF
server {
    listen 80;
    server_name $nginx_config;

    root /var/www/plexactyl/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }
}
EOF"
    sudo ln -s /etc/nginx/sites-available/plexactyl.conf /etc/nginx/sites-enabled/
    sudo systemctl restart nginx

    # Настройка базы данных
    sudo mysql -e "CREATE DATABASE $db_name;"
    sudo mysql -e "CREATE USER '$db_user'@'localhost' IDENTIFIED BY '$db_password';"
    sudo mysql -e "GRANT ALL PRIVILEGES ON $db_name.* TO '$db_user'@'localhost';"
    sudo mysql -e "FLUSH PRIVILEGES;"

    echo "Plexactyl установлен."
}

# Функция для установки Control Panel
install_control_panel() {
    echo "Установка Control Panel..."
    # Установка зависимостей
    sudo apt-get update
    sudo apt-get install -y curl git unzip
    # Скачивание и установка Control Panel
    git clone https://github.com/ControlPanel/ControlPanel.git
    cd ControlPanel
    composer install --no-dev --optimize-autoloader
    cp .env.example .env
    php artisan key:generate --force
    echo "Control Panel установлен."
}

# Функция для установки FastPanel
install_fastpanel() {
    echo "Установка FastPanel..."
    # Установка зависимостей
    sudo apt-get update
    sudo apt-get install -y curl git unzip
    # Скачивание и установка FastPanel
    git clone https://github.com/FastPanel/FastPanel.git
    cd FastPanel
    composer install --no-dev --optimize-autoloader
    cp .env.example .env
    php artisan key:generate --force
    echo "FastPanel установлен."
}

# Функция для установки прокси-системы
install_proxy_system() {
    echo "Установка прокси-системы..."
    # Установка зависимостей
    sudo apt-get update
    sudo apt-get install -y curl git unzip
    # Скачивание и установка прокси-системы
    git clone https://github.com/ProxySystem/ProxySystem.git
    cd ProxySystem
    composer install --no-dev --optimize-autoloader
    cp .env.example .env
    php artisan key:generate --force
    echo "Прокси-система установлена."
}

# Главное меню
main_menu() {
    while true; do
        choice=$(dialog --clear --backtitle "HyProject Installer" \
            --title "Выберите панель управления или систему" \
            --menu "Выберите один из вариантов:" 15 60 6 \
            1 "Pterodactyl" \
            2 "Plexactyl" \
            3 "Control Panel" \
            4 "FastPanel" \
            5 "Прокси-система" \
            6 "Выход" 2>&1 >/dev/tty)

        clear
        case $choice in
            1) install_pterodactyl ;;
            2) install_plexactyl ;;
            3) install_control_panel ;;
            4) install_fastpanel ;;
            5) install_proxy_system ;;
            6) exit 0 ;;
            *) echo "Неверный выбор. Попробуйте снова." ;;
        esac
    done
}

# Запуск главного меню
main_menu
